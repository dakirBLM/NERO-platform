{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Choose Your Path - NERO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png"  href="{% static 'n.png' %}" >
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: linear-gradient(180deg, #6CA8C9 0%, #6CA8C9 30%, white 100%);
            overflow-x: hidden;
        }

        /* ================= MAIN CONTAINER ================= */
        .main-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ================= NAV BAR ================= */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 60px 15px;
            position: relative;
            z-index: 100;
        }

        /* Logo - Made White */
        .logo-container {
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: brightness(0) invert(1);
        }

        .logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Navigation link back to home */
        .nav-link {
            border: 3px solid white;
            padding: 10px 25px;
            border-radius: 50px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ================= HEADER SECTION ================= */
        .header-section {
            text-align: center;
            margin: 40px 0 60px;
            color: white;
        }

        .page-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.1;
        }

        .page-subtitle {
            font-size: 20px;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ================= CHOICE CARDS ================= */
        .choice-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto 60px;
            padding: 0 20px;
        }

        .choice-card {
            background: white;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            transition: all 0.5s ease;
            display: flex;
            flex-direction: column;
            height: 600px;
            position: relative;
            border: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        .choice-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.25);
        }

        /* Ensure tap-activated state is visible across all viewports */
        .choice-card.active .card-hover-content {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .choice-card.active .card-main-content {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        /* Entire Card as Background Image */
        .card-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.8s ease;
            z-index: 1;
        }

        .choice-card:hover .card-background {
            transform: scale(1.1);
        }

        /* Overlay for entire card */
        .card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.8));
            z-index: 2;
            transition: background 0.5s ease;
        }

        .choice-card:hover .card-overlay {
            background: linear-gradient(to bottom, rgba(108, 168, 201, 0.1), rgba(108, 168, 201, 0.9));
        }

        /* Card Content Container */
        .card-content {
            position: relative;
            z-index: 3;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 40px;
            color: white;
            justify-content: flex-end;
        }

        /* Initial Content (Before Hover) */
        .card-main-content {
            transition: all 0.5s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .card-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .card-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Hover Content */
        .card-hover-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            z-index: 5;
            pointer-events: none;
        }

        .choice-card:hover .card-hover-content {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .choice-card:hover .card-main-content {
            opacity: 0;
            transform: translateY(-20px);
        }

        /* When a card is activated (tapped), make hover content scrollable and compact */
        .choice-card.active .card-hover-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            justify-content: center;
        }

        .choice-card.active .hover-title { font-size: 20px; }
        .choice-card.active .hover-subtitle { font-size: 13px; max-width: 100%; }
        .choice-card.active .hover-features li { font-size: 13px; }
        .choice-card.active .hover-actions .btn { font-size: 14px; padding: 10px 16px; }
        .choice-card.active .card-badge { padding: 8px 18px; font-size: 14px; }

        /* Hover Content Sections */
        .hover-header {
            text-align: center;
        }

        .hover-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            color: white;
        }

        .hover-subtitle {
            font-size: 18px;
            opacity: 0.9;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .hover-features {
            list-style: none;
            margin-bottom: 30px;
        }

        .hover-features li {
            padding: 12px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hover-features li:last-child {
            border-bottom: none;
        }

        .hover-features li:before {
            content: "‚úì";
            color: white;
            font-weight: 700;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.2);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hover-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ================= BUTTONS ================= */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 40px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary {
            background: white;
            color: #6CA8C9;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background: #f8f9fa;
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        /* Music Toggle Button (same style as landing page) */
        .music-toggle{
            position:fixed;
            bottom:30px;
            right:30px;
            width:60px;
            height:60px;
            border-radius:50%;
            background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border:3px solid white;
            box-shadow:0 8px 25px rgba(0,0,0,0.3);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:1000;
            transition:all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation:float 3s ease-in-out infinite;
        }

        .music-toggle:hover{ transform:scale(1.15) translateY(-5px); box-shadow:0 12px 35px rgba(0,0,0,0.4); }
        .music-toggle:active{ transform:scale(0.95); }
        .music-toggle.playing{ background:linear-gradient(135deg, #6CA8C9, #5B9AB8); animation:pulse 1.5s ease-in-out infinite, float 3s ease-in-out infinite; }
        .music-icon{ font-size:20px; color:#6CA8C9; transition:all 0.3s ease; }
        .music-toggle.playing .music-icon{ color:white; }

        /* ================= FOOTER ================= */
        .footer {
            background: #2c5282;
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
        }

        .footer p {
            margin: 8px 0;
            font-size: 14px;
        }

        .footer a {
            color: white;
            text-decoration: underline;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .footer a:hover {
            opacity: 1;
        }

        /* ================= ANIMATIONS ================= */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* ================= RESPONSIVE DESIGN ================= */
        @media (max-width: 1200px) {
            .choice-cards {
                max-width: 900px;
            }
        }

        @media (max-width: 992px) {
            .choice-cards {
                grid-template-columns: 1fr;
                max-width: 600px;
            }
            
            .choice-card {
                height: 550px;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 16px 20px 12px;
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }

            .logo-container {
                width: 100px;
                height: 100px;
            }

            .header-section {
                margin: 24px 0 30px;
            }

            .page-title {
                font-size: 30px;
            }

            .page-subtitle {
                font-size: 16px;
                padding: 0 16px;
            }

            .choice-cards {
                padding: 0 18px;
                gap: 22px;
            }

            .card-content {
                padding: 22px;
            }

            .choice-card {
                height: 520px;
            }

            .card-title {
                font-size: 28px;
            }

            .card-badge {
                font-size: 15px;
                padding: 8px 22px;
            }

            .hover-title {
                font-size: 24px;
            }

            .hover-subtitle {
                font-size: 15px;
            }

            .hover-features li {
                font-size: 14px;
            }

            /* Enable tap-to-toggle active state on mobile: show hover content when .active is present */
            .choice-card.active .card-hover-content { opacity: 1; transform: translateY(0); pointer-events: auto; }
            .choice-card.active .card-main-content { opacity: 0; transform: translateY(-20px); }
            /* Allow keyboard focus to show hover content */
            .choice-card:focus-within .card-hover-content { opacity: 1; transform: translateY(0); pointer-events: auto; }
            .choice-card:focus { outline: 2px solid rgba(108,168,201,0.35); }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 12px 16px 10px;
            }

            .nav-link {
                padding: 8px 16px;
                font-size: 14px;
            }

            .page-title {
                font-size: 28px;
            }

            .page-subtitle {
                font-size: 15px;
            }

            .choice-cards {
                padding: 0 12px;
            }

            .card-content {
                padding: 18px;
            }

            .choice-card {
                height: 460px;
            }

            .card-title {
                font-size: 24px;
            }

            .hover-title {
                font-size: 20px;
            }

            .hover-subtitle {
                font-size: 14px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 15px;
            }

            .hover-features li {
                font-size: 13px;
            }

            /* Ensure the hover actions are reachable on small screens */
            .card-hover-content .hover-actions .btn { width: 100%; }
        }

        @media (max-width: 360px) {
            .logo-container { width: 84px; height: 84px; }
            .page-title { font-size: 22px; }
            .choice-card { height: 420px; }
            .card-content { padding: 14px; }
            .card-title { font-size: 20px; }
            .card-badge { padding: 8px 14px; font-size: 14px; }
            .card-hover-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <!-- Main Container (PJAX swap target) -->
    <div id="pjax-container" class="main-container">
        <!-- Navigation Header -->
        <nav class="navbar">
            <div class="logo-container">
                <img src="{% static 'logo1.png' %}" class="logo" alt="NERO Logo">
            </div>
            <a href="{% url 'landing_page' %}" class="nav-link">
                ‚Üê Back to Home
            </a>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Header Section -->
            <div class="header-section fade-in">
                <h1 class="page-title">Choose Your Path</h1>
                <p class="page-subtitle">Select how you want to use NERO Medical Platform</p>
            </div>

            <!-- Choice Cards -->
            <div class="choice-cards">
                <!-- Patient Card -->
                <div class="choice-card fade-in">
                    <!-- Background Image for entire card -->
                      <img src="{% static 'patient.jpeg' %}"  
                         class="card-background" 
                         alt="Patient receiving medical care">
                    
                    <!-- Overlay -->
                    <div class="card-overlay"></div>
                    
                    <!-- Card Content -->
                    <div class="card-content">
                        <!-- Initial Content (Before Hover) -->
                        <div class="card-main-content">
                            <div class="card-badge">PATIENT</div>
                            <h2 class="card-title">I'm a Patient</h2>
                            <p style="font-size: 18px; opacity: 0.9; max-width: 400px; margin-top: 10px;">
                                Click to discover personalized healthcare
                            </p>
                        </div>
                        
                        <!-- Hover Content -->
                        <div class="card-hover-content">
                            <div class="hover-header">
                                <h3 class="hover-title">Personalized Healthcare</h3>
                                <p class="hover-subtitle">
                                    Get matched with specialized clinics based on your medical needs and preferences.
                                </p>
                            </div>
                            
                            <ul class="hover-features">
                                <li>AI-powered clinic matching</li>
                                <li>Secure medical record storage</li>
                                <li>Easy appointment scheduling</li>
                                <li>Progress tracking & follow-ups</li>
                            </ul>
                            
                            <div class="hover-actions">
                                <a href="{% url 'patient_signup' %}" class="btn btn-primary">
                                    Sign Up as Patient
                                </a>
                                <a href="{% url 'login' %}" class="btn btn-secondary">
                                    Existing patient? Login here
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clinic Card -->
                <div class="choice-card fade-in" style="animation-delay: 0.2s">
                    <!-- Background Image for entire card -->
                    <img src="{% static 'uvodka-1.jpg' %}" 
                         class="card-background" 
                         alt="Modern medical clinic">
                    
                    <!-- Overlay -->
                    <div class="card-overlay"></div>
                    
                    <!-- Card Content -->
                    <div class="card-content">
                        <!-- Initial Content (Before Hover) -->
                        <div class="card-main-content">
                            <div class="card-badge">CLINIC</div>
                            <h2 class="card-title">I'm a Clinic</h2>
                            <p style="font-size: 18px; opacity: 0.9; max-width: 400px; margin-top: 10px;">
                                Click to connect with patients
                            </p>
                        </div>
                        
                        <!-- Hover Content -->
                        <div class="card-hover-content">
                            <div class="hover-header">
                                <h3 class="hover-title">Professional Medical Platform</h3>
                                <p class="hover-subtitle">
                                    Connect with patients needing specialized care and manage your clinic efficiently.
                                </p>
                            </div>
                            
                            <ul class="hover-features">
                                <li>Patient management dashboard</li>
                                <li>Medical record access</li>
                                <li>Appointment scheduling system</li>
                                <li>Secure patient communication</li>
                            </ul>
                            
                            <div class="hover-actions">
                                <a href="{% url 'clinic_signup' %}" class="btn btn-primary">
                                    Sign Up as Clinic
                                </a>
                                <a href="{% url 'login' %}" class="btn btn-secondary">
                                    Existing clinic? Login here
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2024 NERO Medical Platform. All rights reserved.</p>
            <p>Need help choosing? <a href="mailto:support@nero-medical.com">Contact our support team</a></p>
        </footer>
    </div>

    <!-- Music controls: ensure a single persistent player across pages. Create only when missing. -->

    <script>
        // PJAX-aware initialization (re-run after content swaps)
        window.pjaxInit = function(){
            // Enhanced hover effects for cards
            document.querySelectorAll('.choice-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-10px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Click handlers for cards (optional for mobile)
            document.querySelectorAll('.choice-card').forEach(card => {
                // make card focusable for keyboard users
                if (!card.hasAttribute('tabindex')) card.setAttribute('tabindex', '0');

                card.addEventListener('click', function(e) {
                    // if a link was clicked, let it proceed (PJAX will handle navigation)
                    if (e.target.closest('a')) return;

                    // toggle active state on tap/click for mobile to reveal actions
                    this.classList.toggle('active');
                    this.setAttribute('aria-expanded', this.classList.contains('active'));
                });

                // keyboard support: Enter/Space to toggle, and when active Enter follows primary action
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (!this.classList.contains('active')) {
                            this.classList.add('active');
                            this.setAttribute('aria-expanded', 'true');
                            this.focus();
                            return;
                        }
                        // if active, activate first primary action link
                        const primary = this.querySelector('.hover-actions .btn-primary');
                        if (primary) {
                            const a = primary.closest && primary.closest('a') ? primary.closest('a') : primary;
                            if (a) a.click();
                        }
                    }
                });
            });

            // Button hover effects
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-3px)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            // Logo click to go back to landing page
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.addEventListener('click', function() {
                    window.location.href = "{% url 'landing_page' %}";
                });
            }

            // Keyboard navigation support
            document.addEventListener('keydown', function(e) {
                const cards = document.querySelectorAll('.choice-card');
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    const currentCard = document.activeElement.closest && document.activeElement.closest('.choice-card');
                    if (currentCard) {
                        const index = Array.from(cards).indexOf(currentCard);
                        if (e.key === 'ArrowRight' && index < cards.length - 1) {
                            cards[index + 1].focus();
                        } else if (e.key === 'ArrowLeft' && index > 0) {
                            cards[index - 1].focus();
                        }
                    }
                }
            });

            // Fade-in animations and image preloads
            document.querySelectorAll('.fade-in').forEach(el => el.style.opacity = '1');
            const imageUrls = [
                'https://images.unsplash.com/photo-1576091160399-112ba8d25d1f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80',
                'https://images.unsplash.com/photo-1516549655669-df3d5f888b75?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80'
            ];
            imageUrls.forEach(url => { const img = new Image(); img.src = url; });
            console.log('NERO Choice Page initialized');
        };

        // Run initializers on load
        window.addEventListener('load', function(){ if (window.pjaxInit) window.pjaxInit(); });

        // Music helper: create controls only if missing (avoids duplicate players and restarts)
        (function(){
            const STORAGE_KEY_PLAYING = 'nero_music_playing';
            const STORAGE_KEY_TIME = 'nero_music_time';

            let musicToggle = document.getElementById('musicToggle');
            let bgMusic = document.getElementById('bgMusic');

            // Create missing elements individually to avoid inconsistent states across PJAX navigation
            if (!musicToggle) {
                musicToggle = document.createElement('button');
                musicToggle.className = 'music-toggle';
                musicToggle.id = 'musicToggle';
                musicToggle.setAttribute('aria-label', 'Toggle background music');
                musicToggle.innerHTML = '<span class="music-icon">üîá</span>';
                // ensure visible/interactable
                musicToggle.style.zIndex = '2000';
                musicToggle.style.display = 'flex';
                musicToggle.style.pointerEvents = 'auto';
                document.body.appendChild(musicToggle);
            }

            if (!bgMusic) {
                bgMusic = document.createElement('audio');
                bgMusic.id = 'bgMusic';
                bgMusic.loop = true;
                bgMusic.preload = 'auto';
                bgMusic.style.display = 'none';
                const s = document.createElement('source');
                s.src = "{% static 'fantasy-music-mage-terrace-cu3ljg1jjhg.mp3' %}";
                s.type = 'audio/mpeg';
                bgMusic.appendChild(s);
                document.body.appendChild(bgMusic);
            }

            let saveInterval = null;
            function updateButton(paused){ const icon = musicToggle.querySelector('.music-icon'); musicToggle.classList.toggle('playing', !paused); musicToggle.setAttribute('aria-pressed', String(!paused)); if (icon) icon.textContent = paused ? 'üîá' : 'üîä'; }
            function startSaving(){ if (saveInterval) clearInterval(saveInterval); saveInterval = setInterval(() => { try { const t = String(bgMusic.currentTime); const ts = String(Date.now()); localStorage.setItem(STORAGE_KEY_TIME, t); localStorage.setItem(STORAGE_KEY_TIME + '_ts', ts); localStorage.setItem(STORAGE_KEY_TIME + '_bak', t); localStorage.setItem(STORAGE_KEY_TIME + '_bak_ts', ts); } catch(e){} }, 250); }
            function stopSaving(){ if (saveInterval) { clearInterval(saveInterval); saveInterval = null; } try { const t = String(bgMusic.currentTime); const ts = String(Date.now()); localStorage.setItem(STORAGE_KEY_TIME, t); localStorage.setItem(STORAGE_KEY_TIME + '_ts', ts); } catch(e){} }
            function markPlaying(isPlaying){ try { localStorage.setItem(STORAGE_KEY_PLAYING, isPlaying ? 'true' : 'false'); } catch(e){} }

            try { const wasSavedPlayingInit = localStorage.getItem(STORAGE_KEY_PLAYING) === 'true'; if (wasSavedPlayingInit) updateButton(false); else updateButton(bgMusic.paused); } catch(e){ updateButton(bgMusic.paused); }

            musicToggle.addEventListener('click', function(e){ e.preventDefault(); if (bgMusic.paused) { const p = bgMusic.play(); if (p && typeof p.then === 'function') { p.then(() => { updateButton(false); markPlaying(true); startSaving(); }).catch(err => { console.warn('Audio playback failed:', err); updateButton(true); markPlaying(false); }); } else { updateButton(false); markPlaying(true); startSaving(); } } else { bgMusic.pause(); updateButton(true); markPlaying(false); stopSaving(); } });

            (function tryResume(){ const wasPlaying = localStorage.getItem(STORAGE_KEY_PLAYING) === 'true'; function getLatestSavedTime(){ try { const tA = localStorage.getItem(STORAGE_KEY_TIME); const tsA = parseInt(localStorage.getItem(STORAGE_KEY_TIME + '_ts') || '0', 10) || 0; const tB = localStorage.getItem(STORAGE_KEY_TIME + '_bak'); const tsB = parseInt(localStorage.getItem(STORAGE_KEY_TIME + '_bak_ts') || '0', 10) || 0; if (tsB > tsA && tB) return parseFloat(tB || '0'); if (tA) return parseFloat(tA || '0'); } catch(e){} return 0; } const savedTime = getLatestSavedTime(); if (!wasPlaying) { updateButton(bgMusic.paused); return; } function resumeNow(){ if (!isNaN(savedTime) && savedTime > 0) { try { bgMusic.currentTime = Math.min(savedTime, bgMusic.duration || savedTime); } catch(e){} } const p = bgMusic.play(); if (p && typeof p.then === 'function') { p.then(() => { updateButton(false); markPlaying(true); startSaving(); }).catch(err => { console.warn('Resume audio failed:', err); }); } else { updateButton(false); markPlaying(true); startSaving(); } } if (bgMusic.readyState >= 2) { resumeNow(); } else { bgMusic.addEventListener('canplay', resumeNow, { once: true }); } })();

            document.addEventListener('visibilitychange', function(){ try { const t = String(bgMusic.currentTime); const ts = String(Date.now()); localStorage.setItem(STORAGE_KEY_TIME, t); localStorage.setItem(STORAGE_KEY_TIME + '_ts', ts); localStorage.setItem(STORAGE_KEY_TIME + '_bak', t); localStorage.setItem(STORAGE_KEY_TIME + '_bak_ts', ts); } catch(e){} });
            window.addEventListener('beforeunload', function(){ try { const t = String(bgMusic.currentTime); const ts = String(Date.now()); localStorage.setItem(STORAGE_KEY_TIME, t); localStorage.setItem(STORAGE_KEY_TIME + '_ts', ts); localStorage.setItem(STORAGE_KEY_TIME + '_bak', t); localStorage.setItem(STORAGE_KEY_TIME + '_bak_ts', ts); } catch(e){} });

            function saveNow(){ try { const t = String(bgMusic.currentTime); const ts = String(Date.now()); localStorage.setItem(STORAGE_KEY_TIME, t); localStorage.setItem(STORAGE_KEY_TIME + '_ts', ts); localStorage.setItem(STORAGE_KEY_TIME + '_bak', t); localStorage.setItem(STORAGE_KEY_TIME + '_bak_ts', ts); localStorage.setItem(STORAGE_KEY_PLAYING, bgMusic && !bgMusic.paused ? 'true' : 'false'); } catch(e){} }
            document.addEventListener('click', function(e){ try { const a = e.target.closest && e.target.closest('a'); if (!a) return; const href = a.getAttribute('href') || ''; if (!href || href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:')) return; const isExternal = href.indexOf('://') !== -1 && !href.startsWith(location.origin); if (isExternal) return; saveNow(); } catch(e){} }, true);
            document.addEventListener('submit', function(){ try { saveNow(); } catch(e){} }, true);
        })();

        // Simple PJAX navigation for same-origin internal links to preserve audio
        (function(){
            async function handleLinkClick(e){
                const a = e.target.closest('a');
                if (!a) return;
                const href = a.getAttribute('href');
                if (!href || href.startsWith('mailto:') || href.startsWith('tel:') || a.target === '_blank') return;
                // Only handle same-origin internal routes
                const url = new URL(href, window.location.href);
                if (url.origin !== window.location.origin) return;

                e.preventDefault();
                try{
                    const res = await fetch(url.href, { credentials: 'same-origin' });
                    if (!res.ok) { window.location.href = url.href; return; }
                    const text = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newContainer = doc.getElementById('pjax-container');
                    if (!newContainer) { window.location.href = url.href; return; }
                    // replace head to ensure styles/scripts in head are applied
                    try { document.head.innerHTML = doc.head.innerHTML; } catch(e) { console.warn('Head replace failed', e); }
                    const container = document.getElementById('pjax-container');
                    container.innerHTML = newContainer.innerHTML;
                    // update title
                    const newTitle = doc.querySelector('title');
                    if (newTitle) document.title = newTitle.textContent;
                    history.pushState({}, '', url.href);
                    if (window.pjaxInit) window.pjaxInit();
                }catch(err){ console.error('PJAX failed, falling back', err); window.location.href = url.href; }
            }

            document.addEventListener('click', function(e){
                const a = e.target.closest && e.target.closest('a');
                if (!a) return;
                // ignore anchors that reference same-page fragments
                const href = a.getAttribute('href') || '';
                if (href.startsWith('#')) return;
                handleLinkClick(e);
            });

            window.addEventListener('popstate', function(){
                // reload location to reflect history change (could improve to fetch)
                fetch(location.href, { credentials: 'same-origin' }).then(res => res.text()).then(text => {
                    const doc = new DOMParser().parseFromString(text, 'text/html');
                    try { document.head.innerHTML = doc.head.innerHTML; } catch(e) { console.warn('Head replace failed', e); }
                    const newContainer = doc.getElementById('pjax-container');
                    if (newContainer) document.getElementById('pjax-container').innerHTML = newContainer.innerHTML;
                    if (window.pjaxInit) window.pjaxInit();
                }).catch(()=> location.reload());
            });
        })();
    </script>
</body>
</html>